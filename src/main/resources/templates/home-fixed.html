<!DOCTYPE html>
<html lang="bg" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="60">
    <title th:text="'Добре дошъл ' + ${user.firstName} + ' ' + ${user.lastName}"></title>
    <link rel="stylesheet" th:href="@{/css/default-test.css}">
    <link rel="stylesheet" href="/css/home-test.css">
    <link rel="stylesheet" href="/css/profile-picture-upload.css">
</head>

<body>
<header>

    <th:block th:insert="~{fragments/nav :: nav}"></th:block>

</header>

<!-- Error/Success съобщения (показват се в основния template ПОД навигацията) -->
<div class="messages-container" style="max-width: 800px; margin: 1rem auto; padding: 0 1rem;">
    <!-- Error message - бял фон, синя рамка, червени букви -->
    <div th:if="${errorMessage}" class="alert alert-danger"
         style="background-color: white;
                border: 2px solid var(--red-main, #dc3545);
                color: #d32f2f;
                padding: 12px;
                border-radius: 6px;
                margin-bottom: 15px;
                text-align: center;
                font-weight: 500;">
        <span th:text="${errorMessage}"></span>
    </div>

    <!-- Success message - син фон, бели букви -->
    <div th:if="${successMessage}" class="alert alert-success"
         style="background-color: var(--red-main, #dc3545);
                color: white;
                padding: 12px;
                border-radius: 6px;
                margin-bottom: 15px;
                text-align: center;
                font-weight: 500;">
        <span th:text="${successMessage}"></span>
    </div>
</div>

<div class="main-container">
    <div class="admin-panel-wrapper" sec:authorize="hasAnyRole('ADMIN', 'TRAINER')">
        <div class="admin-toggle">ИНСТРУМЕНТИ ▾</div>
        <div class="admin-menu">
            <!-- Секция: Заявки -->
            <div class="menu-section">
                <div class="section-title">Заявки</div>
                <ul>
                    <li><a th:href="@{/admin/register-requests}">Заявки за регистрация</a></li>
                    <li><a th:href="@{/events/requests/pending}">Заявки за участие</a></li>
                    <li><a th:href="@{/events/requests/not-pending}">Обработени заявки</a></li>
                </ul>
            </div>

            <!-- Секция: Потребители -->
            <div class="menu-section">
                <div class="section-title">Потребители</div>
                <ul>
                    <li><a th:href="@{/users/list/active}">Активни потребители</a></li>
                    <li><a th:href="@{/admin/users/list/all-users}">Всички потребители</a></li>
                </ul>
            </div>

            <!-- Секция: Действия -->
            <div class="menu-section">
                <div class="section-title">Действия</div>
                <ul>
                    <li><a th:href="@{/admin/add-user}">Нов потребител</a></li>
                    <li><a th:href="@{/events/new}">Добави събитие</a></li>
                    <li><a th:href="@{/posts/create}">Добави публикация</a></li>
                </ul>
            </div>

            <!-- Секция: Система -->
            <div class="menu-section" sec:authorize="hasRole('ADMIN')">
                <div class="section-title">Система</div>
                <ul>
                    <li><a th:href="@{/status}">Състояние на системата</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="user-info">
        <div class="user-bio">
            <table class="info">
                <tr>
                    <th style="text-align: center; padding: 0;">
                        <div style="position: relative; display: inline-block; margin: auto;">
                            <img th:src="${#strings.isEmpty(user.profilePicture) ? 'https://images.unsplash.com/photo-1640960543409-dbe56ccc30e2?q=80&w=200&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' : user.profilePicture}"
                                 alt="Профилна снимка" id="profileImage">

                            <!-- Бутон за промяна на снимката -->
                            <button onclick="document.getElementById('imageUploadForm').style.display='block'"
                                    class="change-picture-btn"
                                    title="Промени снимката">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                    <circle cx="12" cy="13" r="4"></circle>
                                </svg>
                            </button>

                            <!-- Бутон за изтриване на снимката (показва се само ако има снимка) -->
                            <button th:if="${!#strings.isEmpty(user.profilePicture)}"
                                    onclick="confirmRemoveProfilePicture()"
                                    class="remove-picture-btn"
                                    title="Изтрий снимката">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                            </button>
                        </div>
                    </th>
                    <td class="user-buttons">
                        <button th:attr="onclick=|location.href='/users/details/edit/' + '${user.id}'|">Редактиране
                        </button>
                        <button onclick="location.href='/messages/send'">Съобщение</button>
                        <button onclick="location.href='/notifications'">Известия</button>
                        <button th:attr="onclick=|location.href='/events/requests/' + '${user.id}'|">Заявки</button>
                        <button onclick="location.href='/users/list'">Потребители</button>
                        <button onclick="location.href='/users/details/edit/password'">Нова парола</button>
                        <button onclick="window.open('https://t.me/+YD1B8IPga7tjNmQ0', '_blank')"
                                title="Telegram Канал">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <!-- Бял кръг с син кант -->
                                <circle cx="12" cy="12" r="10" fill="white" stroke="var(--red-main)" stroke-width="1"/>
                                <!-- Синият хартиен самолет (официално Telegram лого) -->
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"
                                      fill="var(--red-main)"/>
                            </svg>
                        </button>

                    </td>
                </tr>
                <tr>
                    <th>Име</th>
                    <td th:text="${user.firstName}"></td>
                </tr>
                <tr>
                    <th>Фамилия</th>
                    <td th:text="${user.lastName}"></td>
                </tr>
                <tr th:if="${user.birthDate} != null">
                    <th>Дата на раждане</th>
                    <td th:text="${#temporals.format(user.birthDate,'dd-MM-yyyy г.')}"></td>
                </tr>
                <tr th:if="${user.userPhone} != null">
                    <th>Телефон</th>
                    <td th:text="${user.userPhone}"></td>
                </tr>
                <tr th:if="${user.role != null} != null">
                    <th>Позиция в клуба</th>
                    <td th:text="${user.role.description}"></td>
                </tr>
                <tr th:if="${user.reachedDegree} != null">
                    <th>Защитена степен</th>
                    <td th:text="${user.reachedDegree.description}"></td>
                </tr>
                <tr th:if="${user.interests != null and !#strings.isEmpty(user.interests)}">
                    <th>Интереси</th>
                    <td th:text="${user.interests}"></td>
                </tr>
                <tr th:if="${user.isCompetitor} == true">
                    <th>Статус</th>
                    <td>състезател</td>
                </tr>
                <tr th:if="${user.ageGroup} != null">
                    <th>Възрастова група</th>
                    <td th:text="${user.ageGroup.description}"></td>
                </tr>
                <!--                    <tr><th>Категория</th><td th:text="${user.category}"></td></tr>-->
                <tr th:if="${user.height} != 0">
                    <th>Ръст</th>
                    <td th:text="${user.height} + ' см.'"></td>
                </tr>
                <tr th:if="${user.weight} != 0">
                    <th>Тегло</th>
                    <td th:text="${user.weight} + ' кг.'"></td>
                </tr>
                <tr th:if="${user.achievedFirstPlaces + user.achievedSecondPlaces + user.achievedThirdPlaces > 0}">
                    <th>Отличия</th>
                    <td th:text="${user.achievedFirstPlaces + user.achievedSecondPlaces + user.achievedThirdPlaces}"></td>
                </tr>
                <tr th:if="${user.medicalExamsPassed} != null">
                    <th>Медицински преглед</th>
                    <td th:text="${#temporals.format(user.medicalExamsPassed, 'dd-MM-yyyy г.')}"></td>
                </tr>
                <tr th:if="${user.contactPerson != null and !#strings.isEmpty(user.contactPerson)}">
                    <th>Лице за контакт</th>
                    <td th:text="${user.contactPerson}"></td>
                </tr>
                <tr th:if="${user.contactPersonPhone} != null">
                    <th>Телефон</th>
                    <td th:text="${user.contactPersonPhone}"></td>
                </tr>
            </table>
        </div>
    </div>

    <div class="messages">
        <div class="user-messages">
            <table class="private-messages">
                <caption>Лични Съобщения</caption>
                <thead>
                <tr>
                    <th>Дата</th>
                    <th>От</th>
                    <th>Съдържание</th>
                    <th>Действие</th>
                </tr>
                </thead>
                <tbody th:if="${messages != null and not #lists.isEmpty(messages)}">
                <tr th:each="message : ${messages}">
                    <td data-label="Дата" th:text="${#temporals.format(message.created,'dd-MM-yyyy HH:mm')}"></td>
                    <!-- Дата на съобщението -->
                    <td data-label="От" th:text="${message.sender.firstName + ' ' + message.sender.lastName}"></td>
                    <!-- Изпращач -->
                    <td data-label="Съдържание" th:text="${message.content}"></td> <!-- Съдържание -->
                    <td class="action-buttons">
                        <button th:attr="onclick=|location.href='/messages/reply/' + '${message.id}'|">Отговори</button>
                        <a th:href="@{/messages/remove/{id}(id=${message.id})}">
                            <button>Изчисти</button>
                        </a>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="user-events">
            <table>
                <caption>Предстоящи събития</caption>
                <thead>
                <tr>
                    <th>Начална дата</th>
                    <th>Крайна дата</th>
                    <th>Събитие</th>
                    <th>Изискване</th>
                    <th>Място</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="event : ${events}">
                    <td data-label="Начална дата" th:text="${event.startDate}"></td>
                    <td data-label="Крайна дата" th:text="${event.endDate}"></td>
                    <td data-label="Събитие" th:text="${event.eventDescription}"></td>
                    <td data-label="Изискване" th:text="${event.requirements.description}"></td>
                    <td data-label="Място" th:text="${event.location}"></td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="med-exams" sec:authorize="hasAnyRole('ADMIN','TRAINER')">

            <table id="medical-table">

                <caption>Предстоящи мед. прегледи
                    <div class="tick">
                        <label>
                            <input type="checkbox" id="hideAllCheckbox" onclick="filterCompetitors()">
                            Скрий всички
                        </label>
                    </div>
                    <div class="tick">
                        <label>
                            <input type="checkbox" id="competitorFilterCheckbox" onclick="filterCompetitors()">
                            Покажи само състезателите
                        </label>
                    </div>
                </caption>


                <thead>
                <tr>
                    <th>Име</th>
                    <th>Ел.Поща</th>
                    <th>Състезателен статус</th>
                    <th>Последен преглед</th>
                    <th>Дни до следващият преглед</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="renewalUser : ${examRenewalList}">
                    <td data-label="Име" th:text="|${renewalUser.firstName} ${renewalUser.lastName}|"></td>
                    <td data-label="Поща" th:text="${renewalUser.email}"></td>
                    <td data-label="Състезателен статус"
                        th:text="${renewalUser.isCompetitor} ? 'Състезател' : '-'"></td>
                    <td data-label="Последен преглед"
                        th:text="${renewalUser.medicalExamsPassed == null ? 'Преминете преглед!' : #temporals.format(renewalUser.medicalExamsPassed, 'dd-MM-yyyy ''г.''')}"
                        th:classappend="${renewalUser.medicalExamsPassed == null} ? 'text-red' : ''"></td>
                    <td data-label="Дни до преглед" th:text="${daysLeft[renewalUser.id]}"
                        th:classappend="${daysLeft[renewalUser.id] <= 0} ? 'text-red' : ''"></td>
                </tr>

                </tbody>
            </table>

            <script>
                function filterCompetitors() {
                    const competitorCheckbox = document.getElementById('competitorFilterCheckbox');
                    const hideAllCheckbox = document.getElementById('hideAllCheckbox');
                    const table = document.getElementById('medical-table');
                    if (!table) return;

                    const rows = table.querySelectorAll('tbody tr');

                    if (hideAllCheckbox && hideAllCheckbox.checked) {
                        rows.forEach(row => row.style.display = 'none');
                        return;
                    }

                    rows.forEach(row => {
                        const statusCell = row.querySelector('td:nth-child(3)');
                        const isCompetitor = statusCell.textContent.trim() === 'Състезател';
                        if (competitorCheckbox && competitorCheckbox.checked) {
                            row.style.display = isCompetitor ? '' : 'none';
                        } else {
                            row.style.display = '';
                        }
                    });
                }
            </script>

        </div>


    </div>

</div>

<!-- Форма за качване на профилна снимка (скрита по подразбиране) -->
<div id="imageUploadForm" style="display:none;" class="upload-modal">
    <div class="upload-modal-content">
        <span onclick="document.getElementById('imageUploadForm').style.display='none'"
              class="close-btn">&times;</span>

        <h3>Промяна на профилна снимка</h3>

        <form th:action="@{/users/upload-profile-picture/{userId}(userId=${user.id})}"
              method="post"
              enctype="multipart/form-data"
              onsubmit="return validateImage()">

            <div class="form-group">
                <label for="imageInput">Изберете изображение:</label>

                <!-- Custom file input wrapper -->
                <div class="file-input-wrapper" onclick="document.getElementById('imageInput').click()">
                    <div class="file-input-content">
                        <!-- Add Photo Icon (SVG) -->
                        <svg class="file-input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                            <circle cx="12" cy="13" r="4"></circle>
                            <line x1="12" y1="10" x2="12" y2="16"></line>
                            <line x1="9" y1="13" x2="15" y2="13"></line>
                        </svg>
                        <div class="file-input-text">
                            <strong>Добави снимка</strong>
                            <span id="fileName">Кликни или пусни файл тук</span>
                        </div>
                    </div>
                </div>

                <!-- Hidden file input -->
                <input type="file"
                       id="imageInput"
                       name="image"
                       accept="image/jpeg,image/png,image/jpg,image/gif,image/webp"
                       required
                       onchange="previewImage(event)">

                <small>Позволени формати: JPG, PNG, GIF, WEBP (макс. 5MB)</small>
            </div>

            <!-- Preview на избраната снимка -->
            <div id="imagePreview" style="display:none; margin: 15px 0;">
                <p>Преглед:</p>
                <img id="preview" src="" alt="Preview" style="max-width: 200px; border-radius: 8px;">
            </div>

            <div class="form-actions">
                <button type="submit" class="submit-btn">Качи снимката</button>
                <button type="button"
                        onclick="document.getElementById('imageUploadForm').style.display='none'"
                        class="cancel-btn">Откажи</button>
            </div>
        </form>
    </div>
</div>

<script>
    let isUploading = false; // Flag за предотвратяване на множествени uploads

    // Preview на избраната снимка
    function previewImage(event) {
        const file = event.target.files[0];
        if (file) {
            // Показваме името на файла
            const fileNameDisplay = document.getElementById('fileName');
            if (fileNameDisplay) {
                fileNameDisplay.textContent = file.name;
            }

            // Показваме preview на снимката
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview').src = e.target.result;
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }

    // Drag & Drop функционалност
    window.addEventListener('DOMContentLoaded', function() {
        const dropArea = document.querySelector('.file-input-wrapper');

        if (dropArea) {
            // Prevent defaults
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            // Highlight drop area when item is dragged over it
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

            // Handle dropped files
            dropArea.addEventListener('drop', handleDrop, false);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight(e) {
            dropArea.style.borderColor = 'var(--red-main, #dc3545)';
            dropArea.style.backgroundColor = '#f0f0f0';
        }

        function unhighlight(e) {
            dropArea.style.borderColor = '';
            dropArea.style.backgroundColor = '';
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length > 0) {
                const fileInput = document.getElementById('imageInput');
                fileInput.files = files;

                // Trigger preview
                previewImage({ target: { files: files } });
            }
        }
    });

    // Валидация на размера на файла
    function validateImage() {
        // Проверка дали вече качваме файл
        if (isUploading) {
            alert('Моля изчакайте... Снимката се качва.');
            return false;
        }

        const fileInput = document.getElementById('imageInput');
        const file = fileInput.files[0];

        if (!file) {
            alert('Моля изберете файл!');
            return false;
        }

        // Проверка за размер (5MB = 5 * 1024 * 1024 bytes)
        const maxSize = 5 * 1024 * 1024;
        if (file.size > maxSize) {
            alert('Файлът е твърде голям! Максималният размер е 5MB.');
            return false;
        }

        // Проверка за тип
        const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            alert('Невалиден формат! Позволени са само: JPG, PNG, GIF, WEBP');
            return false;
        }

        // Disable submit бутона и show loading
        isUploading = true;
        const submitBtn = document.querySelector('.submit-btn');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Качване...';
        }

        return true;
    }

    // Потвърждение и изтриване на профилна снимка
    function confirmRemoveProfilePicture() {
        if (confirm('Сигурни ли сте, че искате да премахнете профилната снимка?')) {
            // Създаваме и submit-ваме форма за изтриване
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/users/remove-profile-picture/[[${user.id}]]';

            // Добавяме CSRF token (Thymeleaf)
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = '[[${_csrf.parameterName}]]';
            csrfInput.value = '[[${_csrf.token}]]';
            form.appendChild(csrfInput);

            document.body.appendChild(form);
            form.submit();
        }
    }

    // Автоматично скриване на success/error съобщенията след 5 секунди
    setTimeout(function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            alert.style.transition = 'opacity 0.5s ease';
            alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 500);
        });
    }, 5000);
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const adminToggle = document.querySelector('.admin-toggle');
        // Select only the next sibling .admin-menu
        const adminMenu = adminToggle ? adminToggle.nextElementSibling : null;
        if (adminToggle && adminMenu) {
            adminToggle.addEventListener('click', function() {
                adminMenu.classList.toggle('show');
            });
        }
    });
</script>
</body>

</html>
